{% extends "base.html" %}
{% load static %}

{% block content %}

<p>
    <strong>Disclaimer: This is not associated with any official WCA software.</strong>
</p>
<p>
    This page does not yet support live result, and is based on daily WCA dump. There might be one day delay and also subject to your competition result being updated to WCA.
</p>

<form method="get" action="" onsubmit="fetchCompetitorData(event)">
    <label for="competitor_id">WCA ID:</label>
    <input type="text" id="competitor_id" name="competitor_id" placeholder="Enter WCA ID (e.g. 2009DENG01)" value="2009DENG01">
    <button type="submit">Visualize</button>
</form>

<div id="result" style="margin-top: 20px;"></div>

<script>
    async function fetchCompetitorData(event) {
        console.log("working...");
        event.preventDefault();
        const competitorId = document.getElementById('competitor_id').value;
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = 'Loading...';

        try {
            const response = await fetch(`https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/persons/${competitorId}.json`);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();

            if (data["results"]) {
                const results = data["results"];
                let minBest = null;
                const labels = [];
                const dataPoints = [];
                
                Object.keys(results).forEach(key => {
                    const r = results[key];
                    if (r["333"]) {
                        let rMinBest = null;
                        r["333"].forEach(d => {
                            if (rMinBest === null || d["best"] < rMinBest) {
                                rMinBest = d["best"];
                            }
                        });
                        if (rMinBest !== null) {
                            labels.push(key);
                            dataPoints.push(rMinBest);
                        }
                    }
                });
                labels.reverse();
                dataPoints.reverse();

                if (labels.length > 0 && dataPoints.length > 0) {
                    const canvas = document.createElement('canvas');
                    canvas.id = 'lineChart';
                    resultDiv.appendChild(canvas);

                    new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Minimum "best" for 3x3',
                                data: dataPoints,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 2,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Competition'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Minimum "best" for 3x3'
                                    }
                                }
                            }
                        }
                    });
                }
            } else {
                resultDiv.innerHTML = `<ul><li>No results found.</li></ul>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `Error: ${error.message}`;
        }
    }
</script>

{% endblock content %}