{% extends "base.html" %}
{% load static %}

{% block content %}
<h1>
    Rubik's Clock 7 Simul Flip Practice Tool
</h1>

<p>
    In this tool, the page will randomly generate a scramble and visualization of the clock.<br>
    You may memorize the number/letters for this case, then check correctness with the "Reveal Memo" button below.<br>
    We provided a few preset configurations for the memo, but you may write your custom memo according to the
    instruction.<br>
    Similarly, we provide a few preset letter schema, but you may write your own.
</p>
<p>
    Code credit: <a href="https://sanya.sweetduet.info/cube/7simul_trainer/">7 Simul Trainer by kusano_k</a>
</p>

<div id="appendable-div">
</div>

<div id="scramble" class="is-family-code has-text-centered is-size-7 has-text-weight-bold has-text-grey"></div>
<div style="max-width: 320px; margin: auto;">
    <button id="clock_button" class="button is-primary is-large is-rounded is-fullwidth">New Scramble</button>
</div>

<button id="reveal-button" class="button">Reveal Memo</button>
<button id="hide-button" class="button" style="display: none;">Hide Memo</button>
<div id="memo" class="has-text-centered has-text-weight-bold" display="none"></div>

<script>
    document.getElementById("reveal-button").addEventListener("click", () => {
        document.getElementById("memo").style.display = "block";
        document.getElementById("reveal-button").style.display = "none";
        document.getElementById("hide-button").style.display = "inline-block";
    });

    document.getElementById("hide-button").addEventListener("click", () => {
        document.getElementById("memo").style.display = "none";
        document.getElementById("hide-button").style.display = "none";
        document.getElementById("reveal-button").style.display = "inline-block";
    });

    // Initially hide the memo
    document.getElementById("memo").style.display = "none";
</script>

<h2>Settings</h2>

<h3>Memo</h3>

<div class="field">
    <div class="control">
        <label class="radio">
            <input type="radio" name="memo" value="4 letters">
            4 numbers
        </label>
    </div>
</div>

<div class="field">
    <div class="control">
        <label class="radio">
            <input type="radio" name="memo" value="6 letters">
            6 numbers
        </label>
    </div>
</div>

<div class="field">
    <div class="control">
        <label class="radio">
            <input type="radio" name="memo" value="8 letters">
            8 numbers
        </label>
    </div>
</div>


<div class="field">
    <div class="control">
        <label class="radio">
            <input type="radio" name="memo" value="14 letters">
            14 numbers
        </label>
    </div>
</div>


<div class="field">
    <div class="control">
        <label class="radio">
            <input type="radio" name="memo" value="custom">
            Custom
        </label>
    </div>
</div>

<div class="field">
    <label class="label">Memo</label>
    <div class="control">
        <textarea id="memo_config" class="textarea" rows="14"></textarea>
    </div>
    <p class="help">
        Newline separated.
        Each line must match <code>^((\+|-)(UL|U|UR|L|C|R|DL|D|DR|ul|u|ur|l|c|r|dl|d|dr))+$</code>.
        The starting + is optional.
        Note that <code>(x to y)</code> is <code>-x+y</code> or <code>y-x</code>.
    </p>
</div>

<h3>Letter Schema</h3>

<div class="field">
    <div class="control">
      <label class="radio">
        <input type="radio" name="letters" value="signed">
        Signed numbers
      </label>
    </div>
  </div>

  <div class="field">
    <div class="control">
      <label class="radio">
        <input type="radio" name="letters" value="unsigned">
        Unsigned numbers
      </label>
    </div>
  </div>

  <div class="field">
    <div class="control">
      <label class="radio">
        <input type="radio" name="letters" value="alphabet">
        Alphabet
      </label>
    </div>
  </div>

  <div class="field">
    <div class="control">
      <label class="radio">
        <input type="radio" name="letters" value="hybrid">
        Hybrid
      </label>
    </div>
  </div>

  <div class="field">
    <div class="control">
      <label class="radio">
        <input type="radio" name="letters" value="custom">
        Custom
      </label>
    </div>
  </div>

<div class="field">
    <label class="label">Letters</label>
    <div class="control">
        <input id="letters" class="input" type="text">
    </div>
</div>

<div id="appendable-div-1">
</div>

</div>

<script>
    const visualizeClock = (clocks, annotation, change_pin = null, plot_pointer = true) => {
        render(clocks, "x2", adj.id, canvas.id, convert_to_matrix(annotation), convert_to_change_pin_matrix(change_pin), plot_pointer);
    };

    const elmScramble = document.getElementById("scramble");
    const elmMemo = document.getElementById("memo");
    const elmMemoConfig = document.getElementById("memo_config");
    const elmLetters = document.getElementById("letters");
    elmLetters.value = "0 1 2 3 4 5 6 E D C B A";
    const elmButton = document.getElementById("clock_button");

    const viz = document.createElement("div");
    viz.style = "max-width: 640px; margin: auto;";
    const adj = document.createElement("div");
    adj.id = `adjuster`;
    adj.className = "has-text-centered";
    const canvas = document.createElement("canvas");
    canvas.id = `canvas`;
    adj.appendChild(canvas);
    viz.appendChild(adj);
    document.getElementById(`appendable-div`).appendChild(viz);

    elmLetters.addEventListener("input", e => {
        if (elmLetters.value.trim().split(/ +/).length == 12) {
            elmLetters.classList.remove("is-danger");
        } else {
            elmLetters.classList.add("is-danger");
        }

        update();
    });
    elmLetters.removeAttribute("disabled");

    const method = [
        "D-R+ul-l",
        "-u+c",
        "R-D",
        "u-l",
        "D-C",
        "R-DR+l-u",
        "d-r+UL-L",
        "C-U",
        "r-d",
        "U-L",
        "d-c",
        "r-dr+L-U",
        "R+L-UL-DR+c-u-d",
        "U+D-C-DL-UR-l-r",
    ];

    let scramble;
    let clocks;

    for (const elem of document.querySelectorAll("input[type=radio][name=memo]")) {
        elem.addEventListener("change", e => {
            const m = e.target.value;
            switch (m) {
                case "4 letters":
                    elmMemoConfig.value = [method[0], method[1], method[3], method[6]].join("\n");
                    break;
                case "6 letters":
                    elmMemoConfig.value = [method[0], method[1], method[3], method[6], method[7], method[9]].join("\n");
                    break;
                case "8 letters":
                    elmMemoConfig.value = [method[0], method[1], method[2], method[3], method[6], method[7], method[8], method[9]].join("\n");
                    break;
                case "14 letters":
                    elmMemoConfig.value = method.join("\n");
                    break;
                case "custom":
                    elmMemoConfig.value = ["D-R+ul-l", "-u+c", "u-l", "R-D", "d-r+UL-L", "C-U", "U-L", "r-d"].join("\n");
                    break;
            }

            if (elmMemo) {
                elmMemo.innerText = analyze(clocks, "x2", elmMemoConfig.value, elmLetters.value);
            }
        });
    }
    const eightLettersRadio = document.querySelector("input[name=memo][value='custom']");
    eightLettersRadio.checked = true;
    eightLettersRadio.dispatchEvent(new Event("change"));

    elmMemoConfig.addEventListener("input", e => {
        let ok = true;
        for (const line of elmMemoConfig.value.split(/\n|\r\n/)) {
            if (!line.match(/^((\+|-)(UL|U|UR|L|C|R|DL|D|DR|ul|u|ur|l|c|r|dl|d|dr))*$/)) {
                ok = false;
            }
        }
        if (ok) {
            elmMemoConfig.classList.remove("is-danger");
        } else {
            elmMemoConfig.classList.add("is-danger");
        }

        elmMemo.innerText = analyze(clocks, "x2", elmMemoConfig.value, elmLetters.value);
    });

    for (const elem of document.querySelectorAll("input[type=radio][name=letters]")) {
        elem.addEventListener("change", e => {
            const l = e.target.value;
            if (l=="signed") {
                elmLetters.value = "0 1 2 3 4 5 6 -5 -4 -3 -2 -1";
            }
            if (l=="unsigned") {
                elmLetters.value = "0 1 2 3 4 5 6 7 8 9 10 11";
            }
            if (l=="alphabet") {
                elmLetters.value = "O A B C D E F G H I J K";
            }
            if (l=="hybrid") {
                elmLetters.value = "0 1 2 3 4 5 6 E D C B A";
            }
            if (l=="custom") {
                elmLetters.value = "0 1 2 3 4 5 6 E D C B A";
            }

            if (elmMemo) {
                elmMemo.innerText = analyze(clocks, "x2", elmMemoConfig.value, elmLetters.value);
            }
        });
    }
    const customLetters = document.querySelector("input[name=letters][value='custom']");
    customLetters.checked = true;
    customLetters.dispatchEvent(new Event("change"));

    const generateScramble = () => {
        scramble = Array(14);
        for (let i = 0; i < 14; i++) {
            scramble[i] = Math.random() * 12 | 0;
        }
        clocks = makeClocks(scramble, null);
        elmScramble.innerText = scrambleToString(scramble);
        elmMemo.innerText = analyze(clocks, "x2", elmMemoConfig.value, elmLetters.value);
        visualizeClock(clocks, "", "", true);
    };

    generateScramble();

    elmButton.addEventListener("click", e => {
        generateScramble();
        document.getElementById("hide-button").click();
    });

    const visualizeClockLegacy = (index, clocks, annotation, change_pin = null, plot_pointer = true) => {
        const viz = document.createElement("div");
        viz.style = "max-width: 640px; margin: auto;";
        const adj = document.createElement("div");
        adj.id = `adjuster-${index}`;
        adj.className = "has-text-centered";
        const canvas = document.createElement("canvas");
        canvas.id = `canvas-${index}`;
        adj.appendChild(canvas);
        viz.appendChild(adj);
        document.getElementById(`appendable-div-${index}`).appendChild(viz);
        render(clocks, "x2", adj.id, canvas.id, convert_to_matrix(annotation), convert_to_change_pin_matrix(change_pin), plot_pointer);
    };

    visualizeClockLegacy(1, [[[0, 0, 0], [0, 0, 0], [0, 0, 0]], [[0, 0, 0], [0, 0, 0], [0, 0, 0]]], "UL,L,DL,U,C,D,UR,R,DR,ul,l,dl,u,c,d,ur,r,dr", "", false);

</script>

{% endblock content %}